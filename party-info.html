<!DOCTYPE html>
<html>
  <head>
    <title>Party Info</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
		<link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css" />
	      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <style>
    /* Container for the cards */
#searchResults {
  display: block;
  margin-top: 20px;
}

/* Party Card */
.party-card {
  width: 100%;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 12px 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

/* Hover Effect */
.party-card:hover {
  background-color: #f0f0f0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Left section for Party Code */
.party-card .left {
  width: 90px;
  font-weight: bold;
  font-size: 16px;
  color: #333;
  flex-shrink: 0;
}

/* Right section for Name and City */
.party-card .right {
  margin-left: 20px;
  flex-grow: 1;
}

.party-name {
  font-size: 18
}

.details-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  max-width: 600px;
  margin: auto;
}

.form-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.form-row label {
  width: 30%;
  font-weight: bold;
}

.form-row span,
.form-row input {
  width: 65%;
  font-size: 14px;
}

.form-row input {
  width: 65%;
  padding: 6px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.form-buttons {
  text-align: center;
  margin-top: 20px;
}

input[readonly] {
  background-color: #f5f5f5;
  cursor: not-allowed;
}

    </style>
  </head>
  <body>
  <div id="loadingScreen">
    <img src="images/icon-192x192.png" alt="Loading..." class="loading-icon" />
  </div>
      <!-- NEW WRAPPER for all visible content -->
  <div id="mainContent" class="hidden">
    <div class="container">
      <div class="header-row">
	      <img src="images/icon-192x192.png" alt="Logo" class="logo">
        <h2>Party Info</h2>
	      <a href="javascript:void(0);" onclick="logout()" class="logout-icon" title="Logout">
          <i class="fas fa-right-from-bracket"></i>
        </a>
      </div>

	    <a href="javascript:void(0);" onclick="goToDashboard()" class="home-icon" title="Back to Dashboard">
        <i class="fas fa-home-user"></i>
      </a>
<div id="app">
<div id="status-message" style="margin: 10px 0; color: green;"></div>
              <div class="form-group">

                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="searchInput" placeholder="search Party... ">
                  <div class="input-group-append">
                   
                  </div>
                </div>


              </div>




<template id="rowTemplate">
  <div class="party-card">
    <div class="left">
      <div class="party-code"></div>
    </div>
    <div class="right">
      <div class="party-name"></div>
      <div class="party-city"></div>
    </div>
  </div>
</template>

<div id="searchResults"></div>


<div id="party-details" class="container" style="display: none;">
  <button onclick="goBackToSearch()" class="back-button">? Back to Search Results</button>

  <h2>Party Details</h2>

  <div id="party-info" class="details-grid">
  <div class="form-row">
    <label>Party Code:</label>
    <span id="party-code"></span>
  </div>
  <div class="form-row">
    <label>Party Name:</label>
    <span id="party-name"></span>
  </div>
  <div class="form-row">
    <label>Address:</label>
    <span id="party-address"></span>
  </div>
  <div class="form-row">
    <label>City:</label>
    <span id="party-city"></span>
  </div>
  <div class="form-row">
    <label>Phone:</label>
    <span id="party-phone"></span>
  </div>
  <div class="form-row">
    <label>GST Number:</label>
    <span id="party-gst"></span>
  </div>
  <div class="form-row">
    <label>Rate Code:</label>
    <span id="party-rate-code"></span>
  </div>

<div class="form-buttons">
  <button onclick="editParty()" class="btn btn-primary" id="edit-btn">Edit</button>
  <button onclick="saveParty()" class="btn btn-success" id="save-btn" style="display: none;">Save</button>
  <button onclick="cancelEdit()" class="btn btn-secondary" id="cancel-btn" style="display: none;">Cancel</button>
</div>

</div>


</div>

</div>

</div>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
      function goToDashboard() {
        window.location.href = "index.html"; // redirect back to main dashboard
      }

         function clickEventHandler(e) {
     if (e.target.matches(".select-button")) {
       selectParty(e);
     }

   }

   // For Search
   function inputEventHandler(e) {
     if (e.target.matches("#searchInput")) {
       search();
     }
   }
         function afterPageLoads() {
		 
     
  const token = localStorage.getItem('token');
             const email = localStorage.getItem("sessionEmail");
    if (!token || !email) {
       alert("Session expired. Please login again.");
    window.location.href = 'index.html'; // Redirect to login
    return;
  }

  setDataForSearch();
  initialPartyInfo = document.getElementById("party-info").innerHTML;
//  document.getElementById("party-info").innerHTML = '';
  document.getElementById("searchResults").style.display = "none";
  document.getElementById("mainContent").classList.remove("hidden");
  document.getElementById("searchInput").focus();
 
   }

 function search() {
  document.getElementById("searchResults").style.display = "block"; // or "flex"

  var searchInput = document.getElementById("searchInput").value.toString().toLowerCase().trim();
  var searchWords = searchInput.split(/\s+/); // trim by space
  var searchColumns = [0, 1, 2, 5];

  var resultsArray = searchInput === "" ? [] : data.filter(function(r) {
    return searchWords.every(function(word) {
      return searchColumns.some(function(colIndex) {
        return r[colIndex].toString().toLowerCase().indexOf(word) !== -1;
      });
    });
  });

  var recordCount = searchInput === "" ? "" : "Record count: " + resultsArray.length;
  
  var searchResultsBox = document.getElementById("searchResults");
  var templateBox = document.getElementById("rowTemplate");
  var template = templateBox;

  searchResultsBox.innerHTML = "";

  resultsArray.forEach((r, index) => {
    const clone = template.content.cloneNode(true);
    clone.querySelector(".party-code").textContent = r[0];      // Party Code
    clone.querySelector(".party-name").textContent = r[1];      // Name
    clone.querySelector(".party-city").textContent = r[5];      // City

    const card = clone.querySelector(".party-card");
    card.dataset.partyCode = r[0];

    // Alternate background
    card.style.backgroundColor = index % 2 === 0 ? "#f9f9f9" : "#ffffff";

    // Attach click event to each card
card.addEventListener("click", function() {
  showPartyDetails(r[0]);
});

    searchResultsBox.appendChild(clone);
  });
}


function setDataForSearch() {
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Not logged in. Please log in again.');
    window.location.href = 'index.html';
    return;
  }

  showLoader(); // Show loading indicator

  const params = new URLSearchParams();
  params.append('action', 'getPartyList');
  params.append('token', token);

  fetch(SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: params.toString()
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      data = result.data.slice();
    } else {
      alert("Unauthorized or error: " + result.message);
      window.location.href = 'index.html';
    }
  })
  .catch(error => {
    alert("An error occurred while fetching data.");
    console.error(error);
  })
  .finally(() => {
    hideLoader(); // Always hide loader
  });
}




// ? This function shows the details view
function showPartyDetails(partyCode) {
  const party = data.find(p => p[0] === partyCode);

  if (party) {
    // Populate spans
    document.getElementById("party-code").textContent = party[0];
    document.getElementById("party-name").textContent = party[1];
    document.getElementById("party-address").textContent = party[2];
    document.getElementById("party-city").textContent = party[5];
    document.getElementById("party-phone").textContent = party[6];
    document.getElementById("party-gst").textContent = party[7];
    document.getElementById("party-rate-code").textContent = party[8];

    document.getElementById("save-btn").style.display = "none";
    document.getElementById("searchInput").style.display = "none";
    document.getElementById("searchResults").style.display = "none";
    document.getElementById("party-details").style.display = "block";
  } else {
    console.error("Party not found.");
  }
}




// Go back to search results
function goBackToSearch() {
  document.getElementById("party-details").style.display = "none";
  document.getElementById("searchResults").style.display = "block";
  document.getElementById("searchInput").style.display = "block";
}


// Enable editing of party details
function editParty() {
  const fields = ["party-name", "party-address", "party-city", "party-phone", "party-gst", "party-rate-code"];

  fields.forEach(id => {
    const span = document.getElementById(id);
    const value = span.textContent;
    const input = document.createElement("input");
    input.type = "text";
    input.value = value;
    input.id = id;
    span.replaceWith(input);
  });

  document.getElementById("edit-btn").style.display = "none";
  document.getElementById("save-btn").style.display = "inline-block";
  document.getElementById("cancel-btn").style.display = "inline-block";
}

function cancelEdit() {
  const fields = ["party-name", "party-address", "party-city", "party-phone", "party-gst", "party-rate-code"];

  fields.forEach(id => {
    const input = document.getElementById(id);
    if (input && input.tagName === "INPUT") {
      const span = document.createElement("span");
      span.id = id;
      span.textContent = input.value;
      input.replaceWith(span);
    }
  });

  document.getElementById("edit-btn").style.display = "inline-block";
  document.getElementById("save-btn").style.display = "none";
  document.getElementById("cancel-btn").style.display = "none";

  goBackToSearch();
}



// Save the updated party details to Google Sheets
function saveParty() {
  const fields = {
    "party-name": "partyName",
    "party-address": "partyAddress",
    "party-city": "partyCity",
    "party-phone": "partyPhone",
    "party-gst": "partyGST",
    "party-rate-code": "partyRateCode"
  };

  const partyCode = document.getElementById("party-code").textContent;

  const params = new URLSearchParams();
  params.append("action", "updateParty");
  params.append("token", localStorage.getItem("token"));
  params.append("partyCode", partyCode);

  for (const [inputId, paramKey] of Object.entries(fields)) {
    const input = document.getElementById(inputId);
    const value = input.value;
    params.append(paramKey, value);

    const span = document.createElement("span");
    span.id = inputId;
    span.textContent = value;
    input.replaceWith(span);
  }

  document.getElementById("save-btn").style.display = "none";
  document.getElementById("cancel-btn").style.display = "none";
  document.getElementById("edit-btn").style.display = "inline-block";

  const messageBox = document.getElementById("status-message");

  showLoader(); // Show loading screen

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: params.toString()
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        messageBox.style.color = "green";
        messageBox.textContent = `Party "${partyCode}" updated successfully!`;

        goBackToSearch();
        document.getElementById("searchInput").value = "";
//        document.getElementById("searchInput").focus();
        document.getElementById("searchResults").innerHTML = "";
        setDataForSearch();

      } else {
        messageBox.style.color = "red";
        messageBox.textContent = "Error updating: " + result.message;
      }
    })
    .catch(err => {
      messageBox.style.color = "red";
      messageBox.textContent = "Error: " + err.message;
    })
    .finally(() => {
      hideLoader(); // Always hide loader at end
      document.addEventListener("click", clearMessage);
      document.addEventListener("input", clearMessage);
    });
}

// Function to clear the message on user interaction
function clearMessage() {
  const messageBox = document.getElementById("status-message");
  messageBox.textContent = ""; // Clear the message
  document.removeEventListener("click", clearMessage);
  document.removeEventListener("input", clearMessage);
}


   // For Search 
   document.getElementById("app").addEventListener("input", inputEventHandler);
   document.getElementById("app").addEventListener("click", clickEventHandler);
                          
         document.addEventListener("DOMContentLoaded", afterPageLoads);

      
    </script>

<!--Place this after script.js to show Login upon click of Logout from non index page -->
	<script>
  function showLogin() {
    window.location.href = 'index.html';
  }
</script>

	
  </body>
</html>
